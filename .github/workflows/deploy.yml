    name: Build, Test, and Deploy

    on:
      push:
        branches:
          - '**' # Run on all branches
      pull_request:
        branches:
          - main
      workflow_dispatch: # Allows manual triggering of the workflow

    jobs:
      test:
        runs-on: ubuntu-latest
        timeout-minutes: 10

        steps:
          - name: Checkout code
            uses: actions/checkout@v5

          - name: Setup Node.js
            uses: actions/setup-node@v6
            with:
              node-version: '20'
              cache: 'npm'

          - name: Install dependencies
            run: npm ci

          - name: Install Playwright browsers
            run: npx playwright install --with-deps chromium

          - name: Run ESLint
            run: npm run lint

          - name: Check code formatting
            run: npm run format:check

          - name: Build application
            run: npm run build

          - name: Start preview server
            run: npm run preview &
            env:
              CI: true

          - name: Wait for server
            run: npx wait-on http://localhost:4173 --timeout 30000

          - name: Run Cucumber tests
            run: npm run test:ci
            env:
              BASE_URL: http://localhost:4173/floorplan/

          - name: Upload test results
            if: always()
            uses: actions/upload-artifact@v5
            with:
              name: test-results
              path: test-results/
              retention-days: 30

      deploy:
        needs: test
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        runs-on: ubuntu-latest
        permissions:
          contents: write # Grant write permissions for the action to create the gh-pages branch
          pages: write # Grant write permissions for deploying to GitHub Pages
          id-token: write # Needed for OIDC authentication with GitHub Pages

        steps:
          - name: Checkout repository
            uses: actions/checkout@v5

          - name: Set up Node.js
            uses: actions/setup-node@v6
            with:
              node-version: '22' # Or your preferred Node.js version
              cache: 'npm'

          - name: Install dependencies
            run: npm install

          - name: Run ESLint
            run: npm run lint

          - name: Check code formatting
            run: npm run format:check

          - name: Build project
            run: npm run build

          - name: Configure GitHub Pages
            uses: actions/configure-pages@v5

          - name: Upload build artifact
            uses: actions/upload-pages-artifact@v4
            with:
              path: './dist' # The directory where Vite outputs your build

          - name: Deploy to GitHub Pages
            id: deployment
            uses: actions/deploy-pages@v4